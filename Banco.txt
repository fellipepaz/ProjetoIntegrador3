CREATE DATABASE pi_adega;

use pi_adega;


drop table vendas;

create table cliente (
	id int primary key auto_increment,
	nome varchar(50) not null,    
	cpf int(11),	
	email varchar(50),
    cep int(8),
    numero int not null     
);

create table produto(
	id int primary key auto_increment,
	produto varchar(40) not null,
    filial varchar(40) not null,
	valor double not null,
    quantidade int not null	   
);

create table vendas(
	id int primary key auto_increment, 
    idcliente int not null, 
	datavenda datetime not null,
    foreign key (idcliente) references cliente (id)
);


create table vendas_produtos(
	idvenda int not null,
	idProduto  int not null,
	quantidade_venda int not null,
	total double not null, 
	primary key (idvenda, idProduto),
	foreign key (idvenda) references vendas(id),
	foreign key (idProduto) references produto(id)
);

select* from vendas_produtos;

drop trigger ItensVendaInsert;
DELIMITER $$
CREATE TRIGGER ItensVendaInsert
 before INSERT ON vendas_produtos
 FOR EACH ROW
 BEGIN
 UPDATE Produto SET quantidade = quantidade - NEW.quantidade_venda 
 WHERE id = NEW.idproduto;
 END$$
DELIMITER ;